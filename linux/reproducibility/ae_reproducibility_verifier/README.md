# How to Verify Intel(R) Prebuilt AE Reproducibility

## Purpose

Since Intel(R) prebuilt AEs have been signed by Intel's private key, it's not easy to verify your AE builds against Intel(R) Prebuilt AEs in a common way (e.g. comparing the file checksum).  
So the doc gives an approach to guarantee Intel(R) prebuilt AEs are:

- Built using the open source codebase and toolchain
- Signed using the open source enclave config.xml

## Prerequisites

- Ensure Intel(R) SGX SDK is installed (<https://github.com/intel/linux-sgx#install-the-intelr-sgx-sdk>), and the required environment variables are set:

    ```text
    $ source ${sgx-sdk-install-path}/environment
    ```

- <a id="materials">Prepare below 4 materials</a>
  - **intel_signed_ae**  
 It is the Intel(R) prebuilt AE to be verified, which can be downloaded from <https://download.01.org/intel-sgx/latest/linux-latest/> and <https://download.01.org/intel-sgx/latest/dcap-latest/linux/>.
  - **user_build_unsigned_ae**  
 The unsigned AE is built by yourself in a SGX docker container by following the [reproducibility README.md](../README.md).
  - **user_private_key**  
 This private key is generated by yourself for signing user_build_unsigned_ae.  
 E.g. *'openssl genrsa -out my_priv_key.pem -3 3072'*
  - **intel_ae_config_xml**  
 It is the enclave config.xml used to sign Intel(R) prebuilt AE which is open sourced.  
 E.g. the config.xml of PCE: <https://github.com/intel/linux-sgx/blob/master/psw/ae/pce/config.xml>

## How to verify

- Run below command to verify

  ```text
    $ ./reproducibility_verifier.sh intel_signed_ae user_build_unsigned_ae user_private_key intel_ae_config_xml [output_dir]
  ```  

  Note:
  - To show the usage, please run `./reproducibility_verifier.sh`.
  - The first four required arguments **MUST** in the same order above. (See [Prerequisites - Prepare below 4 materials](#materials)).  
  - The last argument 'output_dir' is optional. If not provided, it will use 'output' by default. The result will be generated in 'output_dir'.
  
- Check the verification result
  - If successful, the exit code will be 0, and the following message will be displayed:

    ```text
    $ ./reproducibility_verifier.sh intel_signed_ae user_build_unsigned_ae user_private_key intel_ae_config_xml
    ...
    Reproducibility Verification PASSED!
    ```

  - If it fails, the exit code will be 1 or 2, and the following message will be displayed:

    ```text
    $ ./reproducibility_verifier.sh intel_signed_ae user_build_unsigned_ae user_private_key intel_ae_config_xml output
    ...
    Reproducibility Verification FAILED!
    Please find the diff contents in output/metadata_diff.txt
    ```

    Meanwhile, you can find the metadata of Intel and user are generated in *./output/intel_metadata.txt* and *./output/user_metadata.txt*
